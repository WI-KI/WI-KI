/*!
 * Image (upload) dialog plugin for Editor.md
 *
 * @file        image-dialog.js
 * @author      pandao
 * @version     1.3.4
 * @updateTime  2015-06-09
 * {@link       https://github.com/pandao/editor.md}
 * @license     MIT
 */
!function(){var e=function(e){e.fn.imageDialog=function(){var e,a=this,i=this.cm,t=this.lang,o=this.editor,n=this.settings,l=i.getCursor(),r=i.getSelection(),d=t.dialog.image,s=this.classPrefix,c=s+"image-dialog";i.focus();var u=function(a){e.find("."+s+"dialog-mask")[a?"show":"hide"]()},f=function(i){if(i){u(!0);var t=i.name,o=i.size,l=(i.type,new RegExp("(\\.("+n.imageFormats.join("|")+"))$","i"));if(""===t)return alert(d.uploadFileEmpty),u(!1),!1;if(!l.test(t))return alert(d.formatNotAllowed+n.imageFormats.join(", ")),u(!1),!1;var r=new FormData;if(!(o>0&&o<=16777216))return alert(d.imageOverSize),u(!1),!1;r.append("file",i);var s=n.uploadURL+(n.uploadURL.indexOf("?")>=0?"&":"?")+"&id="+a.id;n.crossDomainUpload&&(s+="&callback="+n.uploadCallbackURL+"&dialog_id=editormd-image-dialog-"+m),$.ajax({type:"POST",url:s,headers:{token:n.uploadToken},data:r,cache:!1,contentType:!1,processData:!1,success:function(a){u(!1),1===a.success?e.find("[data-url]").val(a.url):alert(a.message)},complete:function(){u(!1)},error:function(e,a){u(!1)}})}};if(o.find("."+c).length<1){var m=(new Date).getTime(),g=(n.imageUpload?'<form class="'+s+'form">':'<div class="'+s+'form">')+"<label>"+d.url+'</label><input type="text" data-url />'+(n.imageUpload?'<div class="'+s+'file-input"><input type="file" name="'+s+'image-file" accept="image/*" /><input type="submit" value="'+d.uploadButton+'" /></div>':"")+"<br/><label>"+d.alt+'</label><input type="text" value="'+r+'" data-alt /><br/>'+(n.imageUpload?"</form>":"</div>");if((e=this.createDialog({title:d.title,width:n.imageUpload?465:380,height:220,name:c,content:g,mask:n.dialogShowMask,drag:n.dialogDraggable,lockScreen:n.dialogLockScreen,maskStyle:{opacity:n.dialogMaskOpacity,backgroundColor:n.dialogMaskBgColor},buttons:{enter:[t.buttons.enter,function(){var e=this.find("[data-url]").val(),a=this.find("[data-alt]").val();if(""===e)return alert(d.imageURLEmpty),!1;var t=""!==a?' "'+a+'"':"";return i.replaceSelection("\n\n!["+a+"]("+e+t+")\n\n"),""===a&&i.setCursor(l.line,l.ch+2),this.hide().lockScreen(!1).hideMask(),this.remove(),!1}],cancel:[t.buttons.cancel,function(){return this.hide().lockScreen(!1).hideMask(),this.remove(),!1}]}})).attr("id",s+"image-dialog-"+m),!n.imageUpload)return;var p=e.find('[name="'+s+'image-file"]');p.bind("change",(function(){return f(p[0].files[0])}))}(e=o.find("."+c)).find('[type="text"]').val(""),e.find('[type="file"]').val(""),this.dialogShowMask(e),this.dialogLockScreen(),e.show(),a.uploadImg.length>0&&f(a.uploadImg.shift())}};"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=e:"function"==typeof define?define.amd?define(["editormd"],(function(a){e(a)})):define((function(a){var i=a("./../../editormd");e(i)})):e(window.editormd)}();